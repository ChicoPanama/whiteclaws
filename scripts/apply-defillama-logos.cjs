const fs = require('fs');
const path = require('path');
const dir = path.join(__dirname, '..', 'public', 'protocols');

// DeFi Llama icon CDN pattern:
// https://icons.llamao.fi/icons/protocols/{slug}?w=48&h=48
const CDN = 'https://icons.llamao.fi/icons/protocols/';

// Map our Immunefi slugs -> DeFi Llama icon slugs
// Found by matching against the 9,236 DeFi Llama icon slugs
const LLAMA_MAP = {
  // Auto-matched (exact or simple transform)
  '88mphv3': '88mph',
  'aloeprotocol': 'aloe',
  'alongside': 'alongside',
  'antefinance': 'ante-finance',
  'anvil': 'anvil',
  'arborfinance': 'arbor-finance',
  'arkadiko': 'arkadiko',
  'aspida': 'aspida',
  'aster': 'aster',
  'axiom': 'axiom',
  'balmy': 'balmy',
  'baofinance': 'bao-finance',
  'basilisk': 'basilisk',
  'beethovenx': 'beethovenx',
  'beets': 'beets',
  'berachain-webapps': 'berachain',
  'beradrome': 'beradrome',
  'bifi': 'bifi',
  'bitflow': 'bitflow',
  'blackwing': 'blackwing',
  'bondprotocol': 'bond-protocol',
  'bprotocol': 'b.protocol',
  'burrow': 'burrow',
  'charm': 'charm-finance',
  'davos': 'davos-protocol',
  'degate': 'degate',
  'delv': 'delv',
  'deriprotocol': 'deriprotocol',
  'dfxfinance': 'dfx-finance',
  'dodov3': 'dodo',
  'eckodao': 'eckodao',
  'econia': 'econia',
  'enosys': 'enosys',
  'ensuro': 'ensuro',
  'extrafinance': 'extra-finance',
  'fassets': 'fassets',
  'felix': 'felix',
  'folksfinance': 'folks-finance',
  'foundation': 'foundation',
  'gammaswap': 'gamma',
  'geniusyield': 'genius-yield',
  'ghostmarket': 'ghostmarket',
  'gogopool': 'gogopool',
  'granite-protocol': 'granite',
  'hakkafinance': 'hakka-finance',
  'hibachi': 'hibachi',
  'hourglass': 'hourglass',
  'hydro': 'hydro',
  'impossiblefinance': 'impossible-finance',
  'integral': 'integral',
  'inverse-finance': 'inverse-finance',
  'ion-protocol': 'ion-protocol',
  'jito-bam-client': 'jito',
  'justlenddao': 'justlend',
  'landx': 'landx-finance',
  'liquidswap': 'liquidswap',
  'lombard-finance': 'lombard-finance',
  'lybrafinance': 'lybra-finance',
  'magpiexyz': 'magpie',
  'mantlelsp': 'mantle-lsp',
  'marsecosystem': 'mars-ecosystem',
  'mayaprotocol': 'maya-protocol',
  'metalswap': 'metalswap',
  'metastreet-yield-pass': 'metastreet',
  'metastreet': 'metastreet',
  'metronome': 'metronome',
  'moneyonchain': 'moneyonchain',
  'mountainprotocol': 'mountain-protocol',
  'native': 'native',
  'nayms': 'nayms',
  'nftfi': 'nftfi',
  'olafinance': 'ola-finance',
  'omni-network': 'omni-network',
  'opyngamma': 'opyn',
  'opynsqueeth': 'opyn',
  'origindefi': 'origin-defi',
  'ostium': 'ostium',
  'pact': 'pact',
  'paragonsdao': 'paragonsdao',
  'parallelwallet': 'parallel',
  'paribus': 'paribus',
  'pikaprotocol': 'pika',
  'pinto': 'pinto',
  'plaza-finance': 'plaza-finance',
  'pods': 'pods',
  'poolshark': 'poolshark',
  'predyfinance': 'predy-finance',
  'primitive': 'primitive',
  'print3r': 'print3r',
  'pstakeoncosmos': 'pstake-finance',
  'reaperfarm': 'reaper-farm',
  'ref-finance': 'ref-finance',
  'revert': 'revert',
  'revest': 'revest-finance',
  'router': 'router-protocol',
  'ruscet': 'ruscet',
  'sectorfinance': 'sector-finance',
  'segmentfinance': 'segment-finance',
  'shellprotocol': 'shell-protocol',
  'silofinance': 'silo',
  'singularitydao': 'singularitydao',
  'skatefi': 'skate-fi',
  'stackingdao': 'stackingdao',
  'stakeeasy': 'stakeeasy',
  'stakelink': 'stake.link',
  'starknet-staking': 'starknet',
  'stellaswap': 'stellaswap',
  'strikefinance': 'strike',
  'summerfi': 'summer.fi',
  'superbots': 'superbots',
  'swappi': 'swappi',
  'symbiosis': 'symbiosis',
  'teahousefinance': 'teahouse-finance',
  'templar-protocol': 'templar-protocol',
  'tetu': 'tetu',
  'thala-protocol': 'thala',
  'timelessandbunni': 'timeless',
  'universalpage': 'universal-page',
  'vaultcraft': 'vaultcraft',
  'vesu': 'vesu',
  'voltz': 'voltz',
  'wildcatprotocol': 'wildcat-protocol',
  'xoxno': 'xoxno',
  'yamatoprotocol': 'yamato-protocol',
  'yieldnest': 'yieldnest',
  'yo-protocol': 'yo-protocol',
  'zenlink': 'zenlink',
  'zest-protocol-v2': 'zest',
  'zksync-os': 'zksync',

  // Manually matched from fuzzy search
  'arcade': 'arcade.xyz',
  'c3': 'c3-exchange',
  'rysk': 'rysk-finance',
  'ebtc': 'ebtc-protocol',
  'royco': 'royco-protocol',
  'pareto': 'pareto-credit',
  'yelay': 'yelay-protocol',
  'cove': 'cove-protocol',
  'duetfinance': 'duet-protocol',
  'tidal': 'tidal-finance',
  'resonate': 'resonate-finance',
  'zodiac': 'zodiacdao',
  'contrax': 'contrax-finance',
  'haven1': 'haven1-hlend',
  'trufin': 'trufin-protocol',
  'furucombofunds': 'furucombo',
  'spot': 'spot-cash',
  'overlay': 'overlay-protocol',
  'hydradx': 'hydradx',
  'gear': 'gearbox',
  'spectral': 'spectral-finance',
  'ceres': 'ceres-demeter',

  // Round 2 fuzzy matches
  'velvetcapital': 'velvet-v2',
  'velvet-capital-v2': 'velvet-v2',
  'termstructurelabs': 'term-structure',
  'tropykus': 'tropykus-finance',
  'enzyme-onyx': 'enzyme-finance',
  'euphrates': 'acala-euphrates',
  'sns': 'sns-1',
  'kiln-webapp': 'kiln',
  'rangeprotocol': 'range-protocol',
  'dex-protocol': 'dexe-protocol',
  'comdex': 'comdex',
  'openzeppelin-stellar': 'openzeppelin',
  'layer3': 'layer3-xyz',
  'pragmaoracle': 'pragma-oracle',
  'unstoppablewallet': 'unstoppable-wallet',
  'integriteenetwork': 'integritee-network',
  'myntandzero': 'mynt',
  'gysr': 'geyser',
};

let updated = 0;
for (const [slug, llamaSlug] of Object.entries(LLAMA_MAP)) {
  const filePath = path.join(dir, slug + '.json');
  if (!fs.existsSync(filePath)) continue;
  const data = JSON.parse(fs.readFileSync(filePath, 'utf-8'));
  if (data.logo_url && data.logo_url !== null) continue;
  data.logo_url = CDN + llamaSlug + '?w=48&h=48';
  fs.writeFileSync(filePath, JSON.stringify(data, null, 2) + '\n');
  updated++;
}

console.log('Applied DeFi Llama logos to ' + updated + ' protocols');

// Final count
let withLogo = 0, withoutLogo = 0;
const files = fs.readdirSync(dir).filter(f => f.endsWith('.json') && f !== '_index.json' && f !== 'protocol_template.json');
for (const f of files) {
  const d = JSON.parse(fs.readFileSync(path.join(dir, f), 'utf-8'));
  if (d.logo_url && d.logo_url !== null) withLogo++;
  else withoutLogo++;
}
console.log('Final: ' + withLogo + ' with logos, ' + withoutLogo + ' without');
